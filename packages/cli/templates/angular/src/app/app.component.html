<div class="flex h-screen flex-col bg-white text-black">
  <!-- Header -->
  <header class="flex items-center justify-between border-b border-neutral-200 px-6 py-3">
    <div class="flex items-center gap-3">
      <div class="h-3.5 w-3.5 bg-black"></div>
      <h1 class="text-base font-semibold tracking-tight">Nearstack Notes</h1>
    </div>
    <div class="flex items-center gap-1.5">
      <button
        (click)="showAI = !showAI"
        [class]="'px-3 py-1.5 text-sm font-medium transition-colors ' + (showAI ? 'bg-black text-white' : 'border border-neutral-300 hover:bg-neutral-100')"
      >
        AI Assistant
      </button>
      <button (click)="handleExport()" class="border border-neutral-300 px-3 py-1.5 text-sm hover:bg-neutral-100">Export</button>
      <button (click)="handleImport()" class="border border-neutral-300 px-3 py-1.5 text-sm hover:bg-neutral-100">Import</button>
    </div>
  </header>

  <!-- Main layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="flex w-72 flex-col border-r border-neutral-200 bg-neutral-50">
      <div class="space-y-2 p-3">
        <input
          type="text"
          [(ngModel)]="search"
          name="search"
          placeholder="Search notes..."
          class="w-full border border-neutral-300 bg-white px-3 py-2 text-sm placeholder:text-neutral-400 focus:border-black focus:outline-none"
        />
        <button (click)="createNote()" class="w-full bg-black px-3 py-2 text-sm font-medium text-white hover:bg-neutral-800">+ New Note</button>
      </div>
      <div class="flex-1 overflow-y-auto">
        <p *ngIf="pinnedNotes.length > 0" class="px-3 pb-1 pt-3 text-[11px] font-semibold uppercase tracking-widest text-neutral-400">Pinned</p>
        <button
          *ngFor="let note of pinnedNotes"
          (click)="selectNote(note.id)"
          [class]="'w-full px-3 py-2.5 text-left transition-colors ' + (note.id === activeNoteId ? 'bg-black text-white' : 'hover:bg-neutral-100')"
        >
          <p [class]="'truncate text-sm font-medium ' + (note.id === activeNoteId ? 'text-white' : 'text-black')">{{ note.title || 'Untitled' }}</p>
          <p [class]="'mt-0.5 truncate text-xs ' + (note.id === activeNoteId ? 'text-neutral-300' : 'text-neutral-500')">{{ note.content.slice(0, 80) || 'Empty note' }}</p>
          <span class="mt-1 text-[11px] text-neutral-400">{{ formatDate(note.updatedAt) }}</span>
        </button>

        <p *ngIf="pinnedNotes.length > 0 && unpinnedNotes.length > 0" class="px-3 pb-1 pt-3 text-[11px] font-semibold uppercase tracking-widest text-neutral-400">All Notes</p>
        <button
          *ngFor="let note of unpinnedNotes"
          (click)="selectNote(note.id)"
          [class]="'w-full px-3 py-2.5 text-left transition-colors ' + (note.id === activeNoteId ? 'bg-black text-white' : 'hover:bg-neutral-100')"
        >
          <p [class]="'truncate text-sm font-medium ' + (note.id === activeNoteId ? 'text-white' : 'text-black')">{{ note.title || 'Untitled' }}</p>
          <p [class]="'mt-0.5 truncate text-xs ' + (note.id === activeNoteId ? 'text-neutral-300' : 'text-neutral-500')">{{ note.content.slice(0, 80) || 'Empty note' }}</p>
          <span class="mt-1 text-[11px] text-neutral-400">{{ formatDate(note.updatedAt) }}</span>
        </button>

        <p *ngIf="filteredNotes.length === 0" class="px-3 py-8 text-center text-sm text-neutral-400">
          {{ search ? 'No notes match your search' : 'No notes yet' }}
        </p>
      </div>
    </aside>

    <!-- Editor -->
    <main class="flex flex-1 flex-col overflow-hidden">
      <ng-container *ngIf="activeNote; else emptyState">
        <!-- Toolbar -->
        <div class="flex items-center justify-between border-b border-neutral-200 px-6 py-2">
          <div class="flex items-center gap-3">
            <button
              (click)="togglePin()"
              [class]="'px-2 py-1 text-xs font-medium transition-colors ' + (activeNote.pinned ? 'bg-black text-white' : 'border border-neutral-300 text-neutral-600 hover:bg-neutral-100')"
            >
              {{ activeNote.pinned ? 'Pinned' : 'Pin' }}
            </button>
            <span class="text-xs text-neutral-400">{{ wordCount }} {{ wordCount === 1 ? 'word' : 'words' }} &middot; {{ editorContent.length }} chars</span>
          </div>
          <button (click)="deleteNote()" class="px-2 py-1 text-xs text-neutral-400 transition-colors hover:text-red-600">Delete</button>
        </div>

        <!-- Title + Content -->
        <div class="flex-1 overflow-y-auto px-6 py-4">
          <input
            type="text"
            [value]="editorTitle"
            (input)="onTitleChange($any($event.target).value)"
            placeholder="Note title"
            class="w-full border-0 p-0 text-2xl font-semibold tracking-tight placeholder:text-neutral-300 focus:outline-none focus:ring-0"
          />
          <textarea
            [value]="editorContent"
            (input)="onContentChange($any($event.target).value)"
            placeholder="Start writing..."
            class="mt-4 block min-h-[400px] w-full resize-none border-0 p-0 text-base leading-relaxed text-neutral-700 placeholder:text-neutral-300 focus:outline-none focus:ring-0"
          ></textarea>
        </div>

        <!-- Tags -->
        <div class="border-t border-neutral-200 px-6 py-3">
          <div class="flex flex-wrap items-center gap-2">
            <span *ngFor="let tag of activeNote.tags" class="inline-flex items-center gap-1 border border-neutral-200 px-2 py-0.5 text-xs">
              {{ tag }}
              <button (click)="removeTag(tag)" class="text-neutral-400 hover:text-black">&times;</button>
            </span>
            <form (ngSubmit)="addTag()" class="inline-flex">
              <input
                [(ngModel)]="tagInput"
                name="tagInput"
                type="text"
                placeholder="Add tag..."
                class="w-24 border-0 p-0 text-xs placeholder:text-neutral-400 focus:outline-none focus:ring-0"
              />
            </form>
          </div>
        </div>
      </ng-container>

      <ng-template #emptyState>
        <div class="flex flex-1 items-center justify-center">
          <div class="text-center text-neutral-400">
            <p class="text-lg font-light">Select a note or create a new one</p>
            <button (click)="createNote()" class="mt-4 bg-black px-4 py-2 text-sm text-white hover:bg-neutral-800">New Note</button>
          </div>
        </div>
      </ng-template>
    </main>

    <!-- AI Panel -->
    <aside *ngIf="showAI" class="flex w-96 flex-col border-l border-neutral-200">
      <div class="flex items-center justify-between border-b border-neutral-200 px-4 py-2">
        <h2 class="text-sm font-semibold">AI Assistant</h2>
        <button *ngIf="messages.length > 0" (click)="clearChat()" class="text-xs text-neutral-400 hover:text-black">Clear</button>
      </div>

      <!-- Setup -->
      <div *ngIf="needsSetup" class="flex flex-1 flex-col items-center justify-center p-6 text-center">
        <p class="text-sm font-medium">Set up a local AI model</p>
        <p class="mt-1 text-xs text-neutral-500">Models run entirely on your device. No data leaves your browser.</p>
        <select
          [ngModel]="selectedModel"
          (ngModelChange)="onModelSelect($event)"
          name="aiModel"
          class="mt-4 w-full border border-neutral-300 bg-white px-3 py-2 text-sm focus:border-black focus:outline-none"
          [disabled]="isDownloading"
        >
          <option value="">Select a model</option>
          <option *ngFor="let m of models" [value]="m.id">{{ m.provider }} &middot; {{ m.name }}</option>
        </select>
        <button
          *ngIf="selectedModelInfo?.status?.state === 'available'"
          (click)="onModelSelect(selectedModel)"
          class="mt-3 w-full bg-black px-3 py-2 text-sm text-white hover:bg-neutral-800"
        >
          Download model
        </button>
        <div *ngIf="isDownloading" class="mt-3 w-full">
          <div class="h-1 w-full overflow-hidden bg-neutral-200">
            <div class="h-full bg-black transition-all" [style.width.%]="downloadProgress * 100"></div>
          </div>
          <p class="mt-1 text-xs text-neutral-500">Downloading {{ (downloadProgress * 100) | number: '1.0-0' }}%</p>
        </div>
      </div>

      <!-- Chat -->
      <ng-container *ngIf="!needsSetup">
        <div class="flex-1 overflow-y-auto p-4">
          <div *ngIf="messages.length === 0" class="flex h-full items-center justify-center text-center text-neutral-400">
            <div>
              <p class="text-sm font-medium">Ask about your notes</p>
              <div class="mt-3 space-y-1.5 text-xs text-neutral-500">
                <p>&ldquo;Summarize my recent notes&rdquo;</p>
                <p>&ldquo;What topics come up most?&rdquo;</p>
                <p>&ldquo;Help me draft a note about...&rdquo;</p>
              </div>
            </div>
          </div>
          <div class="space-y-3">
            <div
              *ngFor="let msg of messages; index as i"
              [class]="'text-sm ' + (msg.role === 'assistant' ? 'text-neutral-700' : 'ml-8 bg-neutral-100 px-3 py-2')"
            >
              {{ msg.content }}
            </div>
            <p *ngIf="error" class="text-xs text-red-600">{{ error }}</p>
          </div>
        </div>
        <form (ngSubmit)="sendMessage()" class="border-t border-neutral-200 p-3">
          <div class="flex gap-2">
            <input
              [(ngModel)]="chatInput"
              name="chatInput"
              placeholder="Ask anything..."
              class="flex-1 border border-neutral-300 bg-white px-3 py-2 text-sm placeholder:text-neutral-400 focus:border-black focus:outline-none"
            />
            <button type="submit" [disabled]="isSending" class="bg-black px-3 py-2 text-sm text-white hover:bg-neutral-800 disabled:opacity-50">Send</button>
          </div>
        </form>
      </ng-container>
    </aside>
  </div>

  <!-- Footer -->
  <footer class="border-t border-neutral-200 px-6 py-2 text-[11px] text-neutral-400">
    {{ notes.length }} {{ notes.length === 1 ? 'note' : 'notes' }} &middot;
    {{ allTags.length }} {{ allTags.length === 1 ? 'tag' : 'tags' }} &middot;
    Stored locally in your browser
  </footer>
</div>
